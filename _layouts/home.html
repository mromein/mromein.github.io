<!DOCTYPE html>
<html>
{% capture style %}{% include home.scss %}{% endcapture %}
{% include head.html %}
<body>
  {% include header.html %}
  <canvas id="bg-canvas"></canvas>
</body>
<script type="text/javascript">
  var loadedVideos = [];

  function requestVideo(num){
    var req = new XMLHttpRequest();
    req.open("GET", "assets/bg_videos/" + num + ".mp4", true);
    req.responseType = "blob";

    req.onload = function() {
       // Onload is triggered even on 404
       // so we need to check the status code
       console.log("here");
       if (this.status === 200) {
          var videoBlob = this.response;
          loadedVideos.push(URL.createObjectURL(videoBlob)); // IE10+
          if(num < 4 && num !== 1){
            requestVideo(num + 1)
          } else if (num >= 4){
            requestVideo(1);
          }
       }
    }
    req.onerror = function(e) {
       console.log(e);
    }

    req.send();
  }
  var loader = PIXI.loader;

  loader.add("bgVideo", "assets/bg_videos/1.mp4")
    .add("largeMask", "assets/large_mask.png")
    .add("smallMask", "assets/small_mask.png");

  loader.onLoad.add(function(){
    console.log("add loading functionality here");
  });

  loader.onComplete.add(function(){
    requestVideo(2);
    console.log("hide loader with this");
  })

  loader.load(function(loader, resources){

    function whichImage(){
      if(window.innerWidth > 1024){
        ratio = resources.largeMask.texture.height / resources.largeMask.texture.width;
        return resources.largeMask.texture;
      } else {
        ratio = resources.smallMask.texture.height / resources.smallMask.texture.width;
        return resources.smallMask.texture;
      }
    }

    var canvas = document.getElementById("bg-canvas");
    var renderer = PIXI.autoDetectRenderer(window.innerWidth, window.innerHeight, { 
      antialias: true,
      view: canvas,
      autoResize: true
    });

    // resources.bgVideo.data.loop = true;
    var counter = 0;

    resources.bgVideo.data.onended = function(){
      resources.bgVideo.data.src = loadedVideos[counter];
      resources.bgVideo.data.play();
      counter ++;
      if(counter > 3) counter = 0;
      console.log("ended")
    };

    var stage = new PIXI.Container();
    var texture = PIXI.Texture.fromVideo(resources.bgVideo.data);

    // var blurFilter = new PIXI.filters.BlurFilter();
    // blurFilter.blur = 20;
    // stage.filters = [blurFilter];

    var bg = new PIXI.Sprite(texture);

    bg.anchor.x = 0.5;
    bg.anchor.y = 0.5;

    bg.position.x = renderer.width / 2;
    bg.position.y = renderer.height / 2;

    stage.addChild(bg);

    var bgFront = new PIXI.Sprite(texture);
    bgFront.width *= 1.2;
    bgFront.height *= 1.2;

    bgFront.anchor.x = 0.5;
    bgFront.anchor.y = 0.5;

    bgFront.position.x = renderer.width / 2;
    bgFront.position.y = renderer.height / 2;

    stage.addChild(bgFront);

    var thing = new PIXI.Sprite(whichImage());

    var ratio = thing.height / thing.width;
    thing.width = window.innerWidth * 0.8;
    thing.height = ratio * thing.width;
    thing.anchor.set(0.5, 0.5);
    thing.position.x = renderer.width / 2;
    thing.position.y = renderer.height / 2;

    bgFront.mask = thing;
    stage.addChild(thing);

    animate();

    function animate(){
        renderer.render(stage);
        requestAnimationFrame(animate);
    }

    function resize(){
      var width = window.innerWidth;
      var height = window.innerHeight;

      if(texture.width < width){
        var bgratio = texture.height / texture.width;
        bg.width = bgFront.width = renderer.width;
        bg.height = bgFront.height = bg.width * bgratio;
      } else {
        bg.width = bgFront.width = texture.width;
        bg.height = bgFront.height = texture.height;
      }

      bgFront.width *= 1.2;
      bgFront.height *= 1.2;

      thing.texture = whichImage();
      thing.width = width * 0.8;
      thing.height = ratio * thing.width;

      thing.position.x = width / 2;
      thing.position.y = height / 2;
      bgFront.position.x = width / 2;
      bgFront.position.y = height / 2;
      bg.position.x = width / 2;
      bg.position.y = height / 2;

      renderer.resize(width, height)
    }

    resize();

    window.onresize = resize;
  });
</script>
</html>